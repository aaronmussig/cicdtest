name: Package Python and Conda

on:
  release:
    types: [ published ]

jobs:
  build-python:
    runs-on: ubuntu-latest
    container:
      image: python:3.6-slim
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build
        run: |
          python -m pip install --upgrade pip
          python -m pip install setuptools wheel
          python setup.py sdist bdist_wheel
      - name: Upload build artifacts
        uses: actions/upload-artifact@v2
        with:
          name: python-dist
          retention-days: 1
          path: |
            dist/*.tar.gz
            dist/*.whl
      - name: Test package
        run: |
          python -m pip install dist/*
          python -m unittest discover

  upload-python:
    needs: build-python
    runs-on: ubuntu-latest
    container:
      image: python:3.6-slim
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v2
        with:
          name: python-dist
      - name: Upload
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USER }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASS }}
        run: |
          python setup.py sdist bdist_wheel
          ls -lah
          twine upload *

  build-conda:
    needs: build-python
    runs-on: ubuntu-latest
    container:
      image: continuumio/anaconda3:latest
    steps:
      - name: Configuration
        run: |
          conda config --add channels bioconda
          conda config --add channels conda-forge
          conda config --add channels ace-internal
          mkdir -p /bld
          rm -rf /bld/*
      - name: Build
        run: |
          conda build conda --output-folder /bld
      - name: Upload
        run: |
          ls -lah /bld
          find /bld/noarch/*.tar.bz2 | xargs anaconda -t ${{ secrets.CONDA_TOKEN }} upload -u ace-internal
